<html>
  <head>
    <link rel="stylesheet" href="/assets/notes.css">
    <link rel="stylesheet" href="/assets/hljs-github.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        messageStyle: "none",
        tex2jax: {
          inlineMath: [["$", "$"], ["\\(", "\\)"]],
          processEscapes: true
        },
        "HTML-CSS": {
          availableFonts: ["TeX"]
        }
      });
    </script>
    <script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
  </head>
  <body>
    <div class="content"><h1 id="node-js">Node.js</h1>
<ul>
<li><a href="#http-server-without-express">HTTP server without express</a></li>
<li><a href="#https">HTTPS</a></li>
<li><a href="#basic-auth">Basic Auth</a></li>
<li><a href="#https-proxy-multiple-servers-with-different-domain-on-same-host">HTTPS proxy (multiple servers with different domain on same host)</a></li>
<li><a href="#-errorhandler"><code>ErrorHandler</code></a></li>
</ul>
<h2 id="http-server-without-express">HTTP server without express</h2>
<p>Example, http body parsing and query string parsing:</p>
<pre><code class="js"><span class="hljs-keyword">const</span> url = <span class="hljs-built_in">require</span>(<span class="hljs-string">'url'</span>);
<span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);
<span class="hljs-keyword">const</span> querystring = <span class="hljs-built_in">require</span>(<span class="hljs-string">'querystring'</span>);

http.createServer((req, res) =&gt; {
  <span class="hljs-keyword">if</span> (req.url === <span class="hljs-string">'/'</span>) {
    res.writeHead(<span class="hljs-number">200</span>, {<span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/plain'</span>})
    res.end(<span class="hljs-string">'Hello World'</span>)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (url.parse(req.url).pathname === <span class="hljs-string">'/search'</span>) {
    <span class="hljs-keyword">const</span> query = querystring.parse(url.parse(req.url).query)
    res.writeHead(<span class="hljs-number">200</span>, {<span class="hljs-string">'Content-type'</span>: <span class="hljs-string">'text/plain; charset=utf-8'</span>})
    res.end(`Received query string: ${<span class="hljs-built_in">JSON</span>.stringify(query, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>)}`)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (req.url === <span class="hljs-string">'/data'</span> &amp;&amp; req.method === <span class="hljs-string">'POST'</span>) {
    <span class="hljs-keyword">let</span> body = <span class="hljs-string">''</span>
    req.on(<span class="hljs-string">'data'</span>, chunk =&gt; body += chunk)
    req.on(<span class="hljs-string">'end'</span>, () =&gt; {
      res.writeHead(<span class="hljs-number">200</span>, {<span class="hljs-string">'Content-type'</span>: <span class="hljs-string">'text/plain; charset=utf-8'</span>})
      res.end(`Received post body: ${body}`)
    })
  } <span class="hljs-keyword">else</span> {
    res.writeHead(<span class="hljs-number">404</span>, {<span class="hljs-string">'Content-type'</span>: <span class="hljs-string">'text/plain; charset=utf-8'</span>})
    res.end(<span class="hljs-string">'404 Not Found'</span>)
  }
}).listen(<span class="hljs-number">8080</span>, () =&gt; console.log(<span class="hljs-string">'Listening on http://127.0.0.1:8080'</span>))
</code></pre>
<h2 id="https">HTTPS</h2>
<p><strong>Set up https certificate:</strong> (Press enter on all fields)</p>
<pre><code>$ openssl req -x509 -newkey rsa:2048 -keyout key.pem -out cert.pem -nodes
</code></pre><p><strong>Setup server:</strong></p>
<pre><code class="js"><span class="hljs-keyword">const</span> https = <span class="hljs-built_in">require</span>(<span class="hljs-string">'https'</span>)

https.createServer({
  key: fs.readFileSync(`${process.env.HOME}/.secrets/ssl/key.pem`),
  cert: fs.readFileSync(`${process.env.HOME}/.secrets/ssl/cert.pem`)
}, (req, res) {
  res.end(<span class="hljs-string">'Hello encrypted world!'</span>)
}).listen(<span class="hljs-number">8080</span>, () =&gt; console.log(<span class="hljs-string">'Listening on https://localhost:8080'</span>))
</code></pre>
<h2 id="basic-auth">Basic Auth</h2>
<p>Use basic auth with https, otherwise the username and password is unencrypted.</p>
<pre><code class="js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
<span class="hljs-keyword">const</span> https = <span class="hljs-built_in">require</span>(<span class="hljs-string">'https'</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">authenticate</span><span class="hljs-params">(req, res, cb)</span> {</span>
  <span class="hljs-keyword">let</span> authorized = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">if</span> (req.headers.authorization) {
    <span class="hljs-keyword">const</span> credentials = <span class="hljs-keyword">new</span> Buffer(req.headers.authorization.replace(<span class="hljs-string">'Basic '</span>, <span class="hljs-string">''</span>), <span class="hljs-string">'base64'</span>).toString().split(<span class="hljs-regexp">/:(.*)/</span>) <span class="hljs-comment">// Split at first :</span>
    <span class="hljs-keyword">if</span> (credentials[<span class="hljs-number">0</span>] === <span class="hljs-string">'user'</span> &amp;&amp; credentials[<span class="hljs-number">1</span>] === <span class="hljs-string">'pass'</span>) {
      authorized = <span class="hljs-literal">true</span>
    }
  }
  <span class="hljs-keyword">if</span> (authorized) {
    cb()
  } <span class="hljs-keyword">else</span> {
    res.writeHead(<span class="hljs-number">401</span>, {<span class="hljs-string">'WWW-Authenticate'</span>: <span class="hljs-string">'Basic realm="Authenticate"'</span>})
    res.end()
  }
}

https.createServer({
  key: fs.readFileSync(`${process.env.HOME}/.secrets/ssl/key.pem`),
  cert: fs.readFileSync(`${process.env.HOME}/.secrets/ssl/cert.pem`)
}, (req, res) =&gt; {
  authenticate(req, res, () =&gt; {
    res.writeHead(<span class="hljs-number">200</span>, {<span class="hljs-string">'Content-type'</span>: <span class="hljs-string">'text/plain; charset=utf-8'</span>})
    res.end(<span class="hljs-string">'Successfully authenticated'</span>)
  })
}).listen(<span class="hljs-number">8080</span>, () =&gt; console.log(<span class="hljs-string">'Listening on https://localhost:8080'</span>))
</code></pre>
<h2 id="https-proxy-multiple-servers-with-different-domain-on-same-host">HTTPS proxy (multiple servers with different domain on same host)</h2>
<pre><code class="js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
<span class="hljs-keyword">const</span> https = <span class="hljs-built_in">require</span>(<span class="hljs-string">'https'</span>)
<span class="hljs-keyword">const</span> httpProxy = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http-proxy'</span>)


<span class="hljs-keyword">const</span> rules = {
  <span class="hljs-string">'www.example.com'</span>: <span class="hljs-string">'http://localhost:3000'</span>,
  <span class="hljs-string">'api.example.com'</span>: <span class="hljs-string">'http://localhost:3001'</span>
}

<span class="hljs-keyword">const</span> proxy = httpProxy.createProxyServer({})

https.createServer({
  key: fs.readFileSync(`${process.env.HOME}/.secrets/ssl/key.pem`),
  cert: fs.readFileSync(`${process.env.HOME}/.secrets/ssl/cert.pem`)
}, (req, res) =&gt; {
  <span class="hljs-keyword">if</span> (req.headers.host <span class="hljs-keyword">in</span> rules) {
    proxy.web(req, res, { target: rules[req.headers.host] })
  } <span class="hljs-keyword">else</span> {
    res.writeHead(<span class="hljs-number">500</span>)
    res.end(`unknown domain <span class="hljs-string">'${req.headers.host}'</span>`)
  }
}).listen(<span class="hljs-number">443</span>, () =&gt; console.log(<span class="hljs-string">'https://localhost'</span>))
</code></pre>
<h2 id="-errorhandler"><code>ErrorHandler</code></h2>
<pre><code class="js"><span class="hljs-comment">// Report errors by email and to error.log</span>

<span class="hljs-keyword">const</span> credentials = <span class="hljs-built_in">JSON</span>.parse(fs.readFileSync(`${process.env.HOME}/.secrets/credentials.json`))

<span class="hljs-keyword">const</span> transporter = nodemailer.createTransport({
  host: <span class="hljs-string">'smtp.gmail.com'</span>,
  port: <span class="hljs-number">465</span>,
  secure: <span class="hljs-literal">true</span>,
  auth: {
    user: credentials.gmailNotifier.user,
    pass: credentials.gmailNotifier.pass
  }
})

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span><span class="hljs-params">(msg)</span> {</span>
  fs.appendFile(`${__dirname}/error.log`, `${(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()).toISOString()} ${msg}\n`)
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendmail</span><span class="hljs-params">(from, subject, text)</span> {</span>
  transporter.sendMail({
    from: `${from} &lt;${credentials.gmailNotifier.user}&gt;`,
    to: credentials.gmail.user,
    subject: subject,
    text: text,
  }, err =&gt; {
    <span class="hljs-keyword">if</span> (err) log(`SENDMAIL ERROR: ${<span class="hljs-built_in">JSON</span>.stringify(err, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>)}`)
  })
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">errorHandler</span><span class="hljs-params">(err, cb)</span> {</span>
  <span class="hljs-keyword">if</span> (!err) <span class="hljs-keyword">return</span>
  log(`ERROR: ${<span class="hljs-built_in">JSON</span>.stringify(err, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>)}`)
  sendmail(<span class="hljs-string">'Fitbit sleep log'</span>, <span class="hljs-string">'Error'</span>, <span class="hljs-built_in">JSON</span>.stringify(err, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>))
}
</code></pre>
</div>
    <!-- <div class="footer-separator"></div> -->
    <!-- <div class="footer"><div class="footer-inner">Viktor Qvarfordt</div></div> -->
  </body>
</html>