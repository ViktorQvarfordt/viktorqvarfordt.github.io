<!doctype html>
<html>
<head>
  <meta charset="utf8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>Crawlr</title>
  <style>
    html {
      font-family: sans-serif;
    }
    @media (max-width: 600px) {
      html {
        font-size: 12px;
      }
    }
    a {
      text-decoration: none;
    }
    a:visited {
      color:blue;
    }
    #series {
      margin: 1em 0;
    }
  </style>
</head>
<body>

<h2>Series</h2>
<div id="series"></div>
New URL: <input type="text" id="url"> <input type="button" value="Get" onclick="showEpisodes(url.value);">

<!-- <iframe src="" id="iframe" webkitallowfullscreen="true" mozallowfullscreen="true" allowfullscreen="true" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="float: right;"></iframe> -->

<h2>Episodes</h2>
<div id="episodes"></div>


<script>

// putlocker uncode video url
var END_OF_INPUT=-1;var arrChrs=new Array("A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/");var reversegetFChars=new Array;for(var i=0;i<arrChrs.length;i++){reversegetFChars[arrChrs[i]]=i}var getFStr;var getFCount;function ntos(e){e=e.toString(16);if(e.length==1)e="0"+e;e="%"+e;return unescape(e)}function readReversegetF(){if(!getFStr)return END_OF_INPUT;while(true){if(getFCount>=getFStr.length)return END_OF_INPUT;var e=getFStr.charAt(getFCount);getFCount++;if(reversegetFChars[e]){return reversegetFChars[e]}if(e=="A")return 0}return END_OF_INPUT}function readgetF(){if(!getFStr)return END_OF_INPUT;if(getFCount>=getFStr.length)return END_OF_INPUT;var e=getFStr.charCodeAt(getFCount)&255;getFCount++;return e}function setgetFStr(e){getFStr=e;getFCount=0}function getF(e){setgetFStr(e);var t="";var n=new Array(4);var r=false;while(!r&&(n[0]=readReversegetF())!=END_OF_INPUT&&(n[1]=readReversegetF())!=END_OF_INPUT){n[2]=readReversegetF();n[3]=readReversegetF();t+=ntos(n[0]<<2&255|n[1]>>4);if(n[2]!=END_OF_INPUT){t+=ntos(n[1]<<4&255|n[2]>>2);if(n[3]!=END_OF_INPUT){t+=ntos(n[2]<<6&255|n[3])}else{r=true}}else{r=true}}return t}function doit(e){return unescape(getF(getF(e)))}

showSeries();

function showSeries() {
  var savedSeries;
  if (localStorage.series) {
    var savedSeries = JSON.parse(localStorage.series);
  } else {
    localStorage.series = '{}';
    savedSeries = {};
  }
  series.innerHTML = '';
  for (var s in savedSeries) {
    series.innerHTML += `<div><a href="#" onclick="showEpisodes('${s}'); event.preventDefault();">${savedSeries[s]}</a></div>`;
  }
}

function showEpisodes(url) {
  var savedSeries = JSON.parse(localStorage.series);
  if (!savedSeries.hasOwnProperty(url)) {
    var name = url.match(/watch-(.*)-tvshow/)[1].replace(/-/g, ' ').replace(/\b./g, function(m) { return m.toUpperCase(); });
    savedSeries[url] = name;
    localStorage.series = JSON.stringify(savedSeries);
    showSeries();
  }
  get(url, function(err, res) {
    if (err) { alert(JSON.stringify('Error')); console.log(err); return; }
    // This regex seems to uniquely capture all episode-urls.
    renderEpisodeList(res);
    episodesRaw = res;
  });
}

function renderEpisodeList(res) {
  episodes.innerHTML = '';
  var re = /<a href="([^>]*)" title="([^>]*)">\s*<strong>[^>]*<\/strong><\/a>\s*&nbsp;&nbsp;-&nbsp;&nbsp;/g;
  while (match = re.exec(res)) {
    var episode = match[2].replace(/.*Season /, 'S').replace(' Episode ', 'E').replace(/(\D)(\d)(\D)/, '$10$2$3').replace(/(\D)(\d)(\D)/, '$10$2$3');
    if (localStorage[match[1]]) {
      var date = dateToYMD(new Date(parseInt(localStorage[match[1]])));
      episodes.innerHTML += `<div><a href="#" onclick="goToEpisode('${match[1]}'); event.preventDefault();">${episode}</a> (${date})</div>`;
    } else {
      episodes.innerHTML += `<div><a href="#" onclick="goToEpisode('${match[1]}'); event.preventDefault();">${episode}</a></div>`;
    }
  }
}

function goToEpisode(url) {
  localStorage[url] = Date.now();
  renderEpisodeList(episodesRaw);
  get(url, function(err, res) {
    if (err) { alert(JSON.stringify('Error')); console.log(err); return; }
    var videoUrl = doit(res.match(/<div class="video">\s*<script type="text\/javascript">document.write\(doit\('([^']*)'\)\);<\/script>\s*<\/div>/)[1]).match(/src="([^"]*)"/)[1];
    // location.href = videoUrl;
    // iframe.src = videoUrl;
    window.open(videoUrl, '_blank');
  });
}

function get(url, cb) {
  var request = new XMLHttpRequest()
  request.open('GET', 'http://cors.io/?u=' + url)
  request.onload = function() {
    if (this.status === 200) {
      cb(null, this.response)
    } else {
      cb(this)
    }
  }
  request.onerror = function() { cb(this) }
  request.send()
}

function dateToYMD(date) {
  var d = date.getDate();
  var m = date.getMonth() + 1;
  var y = date.getFullYear();
  return '' + y + '-' + (m < 10 ? '0' + m : m) + '-' + (d < 10 ? '0' + d : d);
}

</script>

</body>
</html>
